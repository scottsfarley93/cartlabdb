<html>

<head>
  <title>CartLab File Uploader</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">
</head>
<body>
  <div id='main' class='container'>
  <h1 class='page-header'>xCartLabDB File Uploading (beta)</h1>
    <label>Resource ID String</label><input type='text' id='resourceID' name='resourceID' class='form-control' placeholder='Roth_2009_CaGIS'/><br />
    <label>Resource Full Name</label><input type='text' id='resourceName' name='resourceName' class='form-control' placeholder="'A qualitative approach to...'"/><br />
    <div id='authors'>

    <label>First Author: </label><input type='text' id='authorFirst' class='authorFirst form-control' placeholder='Robert' />
    <input type='text' id='authorMiddle' class='authorMiddle form-control' placeholder="E." />
    <input type='text' id='authorLast' class='authorLast form-control' placeholder="Roth" />
    <button id='addAuthor' class='btn btn-success'><span class='glyphicon glyphicon-plus'</button><button id='removeAuthor' class='btn btn-alert'><span class='glyphicon glyphicon-minus'</button>
    </div>
    <br />
    <label>Resource Creation Date</label><input type='date' id='resourceCreationDate' name='resourceDate' class='form-control' val="1/1/2016" /><br />
    <label>Resource Category</label><select id='resourceCategory' class='form-control'>
      <option>project</option>
      <option>ed</option>
      <option>ed/370</option>
      <option>ed/572</option>
      <option>research</option>
      <option>design</option>
    </select> <br / />
    <label>Resource Description</label><input type='text' id='resourceDesc' placeholder='A really cool paper by @roberteroth.' class='form-control' /><br / />
    <label>Tags (comma separated list)</label><input type="text" id='tags' name='tags' placeholder="maps, research, cool stuff" class='form-control' /><br / />
    <div id='refs'>
      <label>Published Reference</label><input type='text' class='form-control' id='ref1' placeholder='Roth, Robert E., and Mark Harrower. "Addressing map interface usability: learning from the Lakeshore Nature Preserve interactive map." Cartographic Perspectives 60 (2008): 46-66.' />
      <button id='addReference' class='btn btn-success'><span class='glyphicon glyphicon-plus' ></span></button>
      <button id='removeReference' class='btn btn-alert'><span class='glyphicon glyphicon-minus' ></span></button>
    </div>
  <br / />
  <label>Notes:</label><input type='text' id='notes' class='form-control' placeholder="Notes you might have about stuff."/><br / />
  <label>Uploader Name</label><input type='text' class='form-control' id='uploaderName' placeholder="Your Name" /><br / />
  <label>Uploader Email</label><input type='text' id='uploaderEmail' class='form-control' placeholder='you@wisc.edu' /><br / />

  <input id='fileUpload' type='file' />
  <br / />
  <button id='submit' class='btn btn-primary btn-large'>Submit Form</button>
</div>
<script   src="https://code.jquery.com/jquery-2.2.4.js"   integrity="sha256-iT6Q9iMJYuQiMWNd9lDyBUStIq/8PuOW33aOqmvFpqI="   crossorigin="anonymous"></script><script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

  <script>
  globals = {}
  globals.hosts = {
    categories : "http://localhost:8080/categories",
    search : "http://localhost:8080/search",
    post : "http://localhost:8080/upload",
    mediaTypes : "http://localhost:8080/mediatypes"
  }
  globals.authorCount = 1;
  globals.refCount = 1;
  $(document).ready(function(){
    getAllowedMediaTypes(); // gets the list of media types
    getCategories(true); // gets the categories list and populates the dropdown
    setDate()
    //actions
    $("#submit").click(function(){
      submit()
    })
    $("#addAuthor").click(function(){
      //add another set of author fields
      globals.authorCount += 1
      html = "<div id='authorRow" + globals.authorCount + "''<label>Author " + globals.authorCount + ": </label><input type='text' id='authorFirst" + globals.authorCount + "' class='authorFirst form-control' placeholder='Robert' /><input type='text' id='authorMiddle" + globals.authorCount + "' class='authorMiddle form-control' placeholder='E.'' /> <input type='text' id='authorLast" + globals.authorCount + "' class='authorLast form-control' placeholder='Roth' />"
      $("#authors").append(html)
    })
    $("#removeAuthor").click(function(){
      //remove the author row if there are more than one on screen
      tag = "#authorRow" + globals.authorCount
      if (globals.authorCount > 1){
        $(tag).remove()
        globals.authorCount -= 1
      }
    })
    $("#addReference").click(function(){
      //add another reference field
      globals.refCount += 1;
      html = "<div id='refRow" + globals.refCount + "'><label>Published Reference " + globals.refCount + "</label><input type='text' id='ref" + globals.refCount + "' class='form-control'/></div>"
      $("#refs").append(html)
    })
    $("#removeReference").click(function(){
      tag = "#refRow" + globals.refCount
      if (globals.refCount > 1){
        $(tag).remove()
        globals.refCount -=1
      }
    })
  })



  function submit(){
    //get the form values
    var resourceID = $("#resourceID").val()
    var resourceName = $("#resourceName").val()
    //get the first author, (required)
    var firstAuthor = {
      'first' : $("#authorFirst").val(),
      'middle' : $("#authorMiddle").val(),
      'last' : $("#authorLast").val()
    }
    authors = [firstAuthor]
    //deal with multiple authors
    for (var i=2; i <= globals.authorCount; i++){
      firstTag = "#authorFirst" + i
      middleTag = "#authorMiddle" + i
      lastTag = "#authorLast" + i
      author = {
        'first' : $(firstTag).val(),
        'middle' : $(middleTag).val(),
        'last' : $(lastTag).val()
      }
      //check that there is really stuff in there
      if ((author['first'] == "") || (author['last'] == "")){
        console.log("Invalid author #" + i)
      }else{
        authors.push(author)
      }

    }
    var resourceCreationDate = $("#resourceCreationDate").val()
    console.log(resourceCreationDate)
    var resourceCategory = $("#resourceCategory option:selected").text()
    var tags = $("#tags").val()
    var ref = $("#ref").val()
    var resourceDescription = $("#resourceDesc").val()
    var notes =$("#notes").val()
    var uploaderName = $("#uploaderName").val()
    var uploaderEmail = $("#uploaderEmail").val()
    var resourceFilename = ""
    //format a metadata object to accompany the file
    var tagList = tags.split(",")
    var metadata = {
      resourceID: resourceID,
      resourceName: resourceName,
      authors: authors,
      creationDate: resourceCreationDate,
      resourceCategory: resourceCategory,
      tags: tagList,
      references: [
        ref
      ],
      resourceDescription: resourceDescription,
      notes: notes,
      uploader: {
        name: uploaderName,
        email: uploaderEmail
      },
      resourceFilename: resourceFilename,

    }
    console.log(metadata)
    //deal with the file upload
    var files = $("#fileUpload").get(0).files;
    //only upload if there is a file present, otherwise we'll have random metadata and no one wants that
    if (files.length > 0){
      var formData = new FormData();
      for (var i = 0; i < files.length; i++) {
        var file = files[i];
        console.log(file.type)
        metadata['resourceMimeType'] = file.type
        metadata['resourceSize'] = file.size
        metadata['resourceFilename'] = file.name
        var metastring = JSON.stringify(metadata)
        // add the files to formData object for the data payload
        formData.append('uploads[]', file, file.name);
        formData.append('metadata', metastring)
      }
      $.ajax({
        url: 'http://localhost:8080/upload',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(data){
            if (data['success']){
              console.log("Upload successful.")
              window.location.href = "/index.html"
            }
        },
        xhr: function() {
          // create an XMLHttpRequest
          var xhr = new XMLHttpRequest();

          // listen to the 'progress' event
          xhr.upload.addEventListener('progress', function(evt) {

            if (evt.lengthComputable) {
              // calculate the percentage of upload completed
              var percentComplete = evt.loaded / evt.total;
              percentComplete = parseInt(percentComplete * 100);

              // update the Bootstrap progress bar with the new percentage
              $('.progress-bar').text(percentComplete + '%');
              $('.progress-bar').width(percentComplete + '%');

              // once the upload reaches 100%, set the progress bar text to done
              if (percentComplete === 100) {
                $('.progress-bar').html('Done');
              }

            }

          }, false);

          return xhr;
        }
      });
    }
  }

  function getAllowedMediaTypes(){
    //get the list of media types that we are allowed to upload to the server
    $.getJSON(globals.hosts.mediaTypes, function(data){
      globals.mediaTypes = data
      globals.mediaChecklist = []
      for (var i=0; i<globals.mediaTypes; i++){
        mime = globals.mediaTypes[i]['mimetype']
        globals.mediaChecklist.push(mime)
      }
    })
  }

  function getCategories(populate){
    $.getJSON(globals.hosts.categories, function(data){
      globals.categories = data
      if (populate){
        //populate the dropdown menu
        $("#resourceCategory").empty()
        categoryData = data['data']
        for (var i = 0; i < categoryData.length; i++){
          html = "<option value='" +categoryData[i]['categorytext'] + "'>" + categoryData[i]['categorytext'] + "</option>"
          $("#resourceCategory").append(html)
        }
      }
    })
  }

  function setDate(){
    var now = new Date();

    var day = ("0" + now.getDate()).slice(-2);
    var month = ("0" + (now.getMonth() + 1)).slice(-2);

    var today = now.getFullYear()+"-"+(month)+"-"+(day) ;

    $('#resourceCreationDate').val(today);
  }

  function validateForm(){
    //validate against rules, returns TRUE if we can upload the data and false if the form data is not allowed
    //rule 1: resourceID can have no spaces or special characters other than (- or _) and alphanumeric

  }
  </script>
</body>
</html>
