<html>

<head>
  <title>CartLab File Uploader</title>
</head>
<body>
  <h1>xCartLabDB File Uploading (beta)</h1>
    <label>Resource ID:</label><input type='text' id='resourceID' name='resourceID' placeholder='Roth_2009_CaGIS'/><br />
    <label>Resource Full Name</label><input type='text' id='resourceName' name='resourceName' placeholder="'A qualitative approach to...'"/><br />
    <label>Author First</label><input type='text' id='authorFirst' name='authorFirst' placeholder='Robert' /><br / />
    <label>Author Middle</label><input type='text' id='authorMiddle' name='authorMiddle' placeholder="E." /><br />
    <label>Author Last</label><input type='text' id='authorLast' name='authorLast' placeholder="Roth" /><br />
    <label>Resource Creation Date</label><input type='date' id='resourceDate' name='resourceDate' placeholder="1/1/2015" /><br />
    <label>Resource Category</label><select id='resourceCategory'>
      <option>project</option>
      <option>ed</option>
      <option>ed/370</option>
      <option>ed/572</option>
      <option>research</option>
      <option>design</option>
    </select> <br / />
    <label>Resource Description</label><input type='text' id='resourceDesc' placeholder='A really cool paper by @roberteroth.' /><br / />
    <label>Tags (comma separated list)</label><input type="text" id='tags' name='tags' placeholder="maps, research, cool stuff" /><br / />
    <label>Published Reference</label><input type='text' id='ref' name='ref' placeholder='Roth, Robert E., and Mark Harrower. "Addressing map interface usability: learning from the Lakeshore Nature Preserve interactive map." Cartographic Perspectives 60 (2008): 46-66.' /><br / />
  <br / />
  <label>Notes:</label><input type='text' id='notes' placeholder="Notes you might have about stuff."/><br / />
  <label>Uploader Name</label><input type='text' id='uploaderName' placeholder="Your Name" /><br / />
  <label>Uploader Email</label><input type='text' id='uploaderEmail' placeholder='you@wisc.edu' /><br / />

  <input id='fileUpload' type='file' />
  <br / />
  <button id='submit'>Submit Form</button>
  <script   src="https://code.jquery.com/jquery-3.1.0.js"   integrity="sha256-slogkvB1K3VOkzAI8QITxV3VzpOnkeNVsKvtkYLMjfk="   crossorigin="anonymous"></script>
  <script>
  globals = {}
  globals.hosts = {
    categories : "http://localhost:8080/categories",
    search : "http://localhost:8080/search",
    post : "http://localhost:8080/upload",
    mediaTypes : "http://localhost:8080/mediatypes"
  }
  $(document).ready(function(){
    getAllowedMediaTypes(); // gets the list of media types
    getCategories(true); // gets the categories list and populates the dropdown
    $("#submit").click(function(){
      submit()
    })
  })

  function submit(){
    //get the form values
    var resourceID = $("#resourceID").val()
    var resourceName = $("#resourceName").val()
    var authorFirst = $("#authorFirst").val()
    var authorLast = $("#authorLast").val()
    var authorMiddle = $("#authorMiddle").val()
    var resourceCreationDate = $("#resourceCreationDate").val()
    var resourceCategory = $("#resourceCategory option:selected").text()
    var tags = $("#tags").val()
    var ref = $("#ref").val()
    var resourceDescription = $("#resourceDesc").val()
    var notes =$("#notes").val()
    var uploaderName = $("#uploaderName").val()
    var uploaderEmail = $("#uploaderEmail").val()
    var resourceFilename = ""
    //format a metadata object to accompany the file
    var tagList = tags.split(",")
    var metadata = {
      resourceID: resourceID,
      resourceName: resourceName,
      authors: [
        {
          first: authorFirst,
          middle: authorMiddle,
          last: authorLast
        },
        {
          first: authorFirst,
          middle: authorMiddle,
          last: authorLast
        }
      ],
      creationDate: resourceCreationDate,
      resourceCategory: resourceCategory,
      tags: tagList,
      references: [
        ref
      ],
      resourceDescription: resourceDescription,
      notes: notes,
      uploader: {
        name: uploaderName,
        email: uploaderEmail
      },
      resourceFilename: resourceFilename,

    }
    var metastring = JSON.stringify(metadata)
    //deal with the file upload
    var files = $("#fileUpload").get(0).files;
    //only upload if there is a file present, otherwise we'll have random metadata and no one wants that
    if (files.length > 0){
      var formData = new FormData();
      for (var i = 0; i < files.length; i++) {
        var file = files[i];
        console.log(file.type)
        metadata['resourceMimeType'] = file.type
        metadata['resourceSize'] = file.size
        // add the files to formData object for the data payload
        formData.append('uploads[]', file, file.name);
        formData.append('metadata', metastring)
      }
      $.ajax({
        url: 'http://localhost:8080/upload',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(data){
            console.log('upload successful!');
        },
        xhr: function() {
          // create an XMLHttpRequest
          var xhr = new XMLHttpRequest();

          // listen to the 'progress' event
          xhr.upload.addEventListener('progress', function(evt) {

            if (evt.lengthComputable) {
              // calculate the percentage of upload completed
              var percentComplete = evt.loaded / evt.total;
              percentComplete = parseInt(percentComplete * 100);

              // update the Bootstrap progress bar with the new percentage
              $('.progress-bar').text(percentComplete + '%');
              $('.progress-bar').width(percentComplete + '%');

              // once the upload reaches 100%, set the progress bar text to done
              if (percentComplete === 100) {
                $('.progress-bar').html('Done');
              }

            }

          }, false);

          return xhr;
        }
      });
    }
  }

  function getAllowedMediaTypes(){
    //get the list of media types that we are allowed to upload to the server
    $.getJSON(globals.hosts.mediaTypes, function(data){
      globals.mediaTypes = data
      globals.mediaChecklist = []
      for (var i=0; i<globals.mediaTypes; i++){
        mime = globals.mediaTypes[i]['mimetype']
        globals.mediaChecklist.push(mime)
      }
    })
  }

  function getCategories(populate){
    $.getJSON(globals.hosts.categories, function(data){
      globals.categories = data
      if (populate){
        //populate the dropdown menu
        $("#resourceCategory").empty()
        categoryData = data['data']
        for (var i = 0; i < categoryData.length; i++){
          html = "<option>" + categoryData[i]['categorytext'] + "</option>"
          $("#resourceCategory").append(html)
        }
      }
    })
  }

  function validateForm(){
    //validate against rules, returns TRUE if we can upload the data and false if the form data is not allowed

  }
  </script>
</body>
</html>
